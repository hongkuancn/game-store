{% extends "games/parent.html" %}

{% block prerequisites %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/gaming_layout.css' %}">
{% endblock %}

{% block content %}
    <div class="row" style="background-color: #1d3e53; margin-left: 0px; margin-right: 0px; min-height: 100vmax;">
        <div class="col-xs-2 col-sm-2 col-lg-2" >
        </div>
        <div class="col-xs-12 col-sm-8 col-lg-8" >
            <!-- header to gaming -->
            <div class="row">
                <div class="col-xs-6 col-sm-6 col-lg-9 title">
                    <h1>{{game.name}}</h1>
                </div>
                <div class="col-xs-6 col-sm-6 col-lg-3">
                    <!-- TODO: add price to the button -->
                    <!-- <button class="btn btn-danger navbar-btn">Buy $</button> -->
                    <form action="http://payments.webcourse.niksula.hut.fi/pay/" method="POST" id="buy">
                        <input type="hidden" name="pid" value={{pid}} />
                        <input type="hidden" name="sid" value={{sid}} />
                        <input type="hidden" name="success_url" value="http://localhost:8000/payment/success" />
                        <input type="hidden" name="cancel_url" value="http://localhost:8000/payment/cancel" />
                        <input type="hidden" name="error_url" value="http://localhost:8000/payment/error" />
                        <input type="hidden" name="checksum" value={{checksum}} />

                        <label for="id_amount"></label>
                        <input type="hidden" id="id_amount" name="amount" value={{amount}} />
                        <input type="submit" value="Buy for {{amount}}â‚¬" class="btn"/>
                    </form>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12 col-sm-9 col-lg-9" >
                    <iframe class="game" src="{{game.url_link}}"></iframe>
                    <div class="row">
                        <div class="col-xs-3 col-sm-6 col-lg-3">
                            <p><a href="#">SHARE</a></p>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-3 col-lg-3" >
                    <h2>Introduction</h2>
                    <p>{{game.description}}</p>
                    <h2>Highest Scores</h2>
                    <table id="bestScore">

                    </table>
                </div>
            </div>
        </div>
    </div>
    {% load static %}
    {% endblock %}

    {% block javascript %}

    <script src="{% static 'js/jquery.cookie.js' %}"></script>
    <script>
    $(document).ready( function() {
        "use strict";
        var iframe = document.getElementsByTagName("iframe")[0];
        var csrftoken = $.cookie('csrftoken');

    // Listen incoming messages
        window.addEventListener("message", function(evt) {
            console.log(JSON.stringify(evt.data));
            switch(evt.data.messageType) {
                case "SETTING":
                    if ( iframe.offsetWidth > evt.data.options.width)
                    {
                        iframe.style.width = evt.data.options.width+"px";
                        iframe.style.height = evt.data.options.height+"px";
                    }
                    break;
                case "ERROR":
                    alert(evt.data.info);
                    break;
            }

            function csrfSafeMethod(method) {
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            $.ajax({
                method: "POST",
                url: '/gaming/ajax',
                data: {data: JSON.stringify(evt.data), id: {{game.id}} },
                dataType: 'json',
                success: function (data) {
                    if(data.messageType=="LOAD") {
                        data.gameState = JSON.parse(data.gameState.replace(/'/g, '"'));
                        iframe.contentWindow.postMessage(data, '*');
                    } else if(data.messageType="SCORE"){
                        $("#bestScore").html(data.bestScore);
                    }
                }
            });
        });

    });
    </script>
{% endblock %}